name: CI with Jira Integration

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:

jobs:
  jira-ci:
    runs-on: ubuntu-latest

    steps:

      # Step 1: Checkout code
      - uses: actions/checkout@v4

      # Step 2: Extract commit message safely
      - name: Get Commit Message
        id: commit
        run: |
          commit="$(git log -1 --pretty=%B)"
          echo "Commit Message:"
          echo "$commit"

          # Extract JIRA Ticket ID from commit (format: KAN-123)
          jira=$(echo "$commit" | grep -oE 'KAN-[0-9]+') || true

          if [ -z "$jira" ]; then
            echo "⚠️ No Jira ticket found."
            echo "jira=" >> $GITHUB_OUTPUT
          else
            echo "Found Jira ticket: $jira"
            echo "jira=$jira" >> $GITHUB_OUTPUT
          fi

      # Step 3: Skip Jira steps if no ticket
      - name: Stop if no Jira ticket
        if: ${{ steps.commit.outputs.jira == '' }}
        run: echo "No Jira ticket found. Skipping Jira update steps."

      # Step 4: Add comment to Jira issue
      - name: Add comment to Jira Issue
        if: ${{ steps.commit.outputs.jira != '' }}
        run: |
          curl -X POST \
            -H "Authorization: Basic ${{ secrets.JIRA_AUTH }}" \
            -H "Content-Type: application/json" \
            --data "{\"body\": \"Commit pushed in GitHub: $GITHUB_SHA\"}" \
            "https://${{ secrets.JIRA_DOMAIN }}/rest/api/3/issue/${{ steps.commit.outputs.jira }}/comment"

      # Step 5: Transition Jira Issue (optional)
      - name: Move Jira Issue to In Progress
        if: ${{ steps.commit.outputs.jira != '' }}
        run: |
          curl -X POST \
            -H "Authorization: Basic ${{ secrets.JIRA_AUTH }}" \
            -H "Content-Type: application/json" \
            --data '{ "transition": { "id": "21" } }' \
            "https://${{ secrets.JIRA_DOMAIN }}/rest/api/3/issue/${{ steps.commit.outputs.jira }}/transitions"
