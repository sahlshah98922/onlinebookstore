name: CI with Jira Integration

on:
  push:
    branches:
      - '*'   # triggers on all branches
  workflow_dispatch:
    inputs:
      JIRA_ISSUE:
        description: 'Jira Ticket ID (e.g., KAN-1)'
        required: false
        default: 'KAN-1'

jobs:
  jira-ci:
    runs-on: ubuntu-latest

    steps:

      # Step 1: Checkout code
      - uses: actions/checkout@v4

      # Step 2: Get last commit message
      - name: Get Commit Message
        id: commit
        run: |
          commit="$(git log -1 --pretty=%B)"
          echo "Commit Message:"
          echo "$commit"

          # Extract Jira ticket ID (KAN-123)
          jira=$(echo "$commit" | grep -oE 'KAN-[0-9]+') || true

          if [ -z "$jira" ]; then
            echo "⚠️ No Jira ticket found."
            echo "jira=" >> $GITHUB_OUTPUT
          else
            echo "Jira Ticket: $jira"
            echo "jira=$jira" >> $GITHUB_OUTPUT
          fi

      # Step 3: Stop if no Jira ticket
      - name: Skip if no ticket
        if: ${{ steps.commit.outputs.jira == '' }}
        run: echo "No Jira ticket found. Skipping Jira update steps."

      # Step 4: Add comment in Jira
      - name: Add Jira Comment
        if: ${{ steps.commit.outputs.jira != '' }}
        run: |
          curl --request POST \
            --url "https://sahil-shah.atlassian.net/rest/api/3/issue/${{ steps.commit.outputs.jira }}/comment" \
            --user "${{ secrets.JIRA_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            --header 'Content-Type: application/json' \
            --data "{
              \"body\": \"GitHub: Commit pushed to branch '${GITHUB_REF##*/}'\"
            }"

      # Step 5: Transition Jira Issue
      - name: Move Jira Ticket to In Progress
        if: ${{ steps.commit.outputs.jira != '' }}
        run: |
          curl --request POST \
            --url "https://sahil-shah.atlassian.net/rest/api/3/issue/${{ steps.commit.outputs.jira }}/transitions" \
            --user "${{ secrets.JIRA_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            --header 'Content-Type: application/json' \
            --data "{
              \"transition\": { \"id\": \"31\" }
            }"
